[platformio]
src_dir = main
default_envs = esp32-serial

; ============================================================================
; GEMEINSAME BASIS-KONFIGURATION
; ============================================================================
[env]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
board = esp32doit-devkit-v1
framework = espidf, arduino
board_build.partitions = partitions.csv

monitor_filters = esp32_exception_decoder, colorize, time
monitor_speed = 115200

; --- Flash-Settings ---
board_upload.flash_size = 4MB
board_upload.maximum_size = 4063232
board_build.flash_mode = dio
board_build.f_flash = 80000000L

; --- GZIP UI Compression ---
extra_scripts = pre:scripts/build_hook.py

; --- Dependencies ---
lib_deps =
    bblanchon/ArduinoJson @ ^6.21.5

lib_ignore =
    OpenThread
    BLE
    BluetoothSerial
    SimpleBLE
    WiFiProv
    SPIFFS
    Insights
    RainMaker
    Zigbee
    HTTPClient
    HTTPUpdate
    NetworkClientSecure

lib_ldf_mode = chain+

custom_component_remove =
    espressif/esp_hosted
    espressif/esp_wifi_remote
    espressif/network_provisioning
    espressif/esp-dsp
    espressif/esp_modem
    espressif/libsodium
    espressif/esp_insights
    espressif/esp_diag_data_store
    espressif/cbor
    espressif/esp_rainmaker
    espressif/rmaker_common
    espressif/qrcode
    espressif/esp-sr
    espressif/esp-modbus
    chmorgan/esp-libhelix-mp3
    espressif/esp32-camera
    espressif/esp-zboss-lib
    espressif/esp-zigbee-lib

build_unflags =
    -std=c++17
    -std=gnu++2b
    -mdisable-hardware-atomics

build_flags =
    -I "/home/robothaler/credentials"
    -I "/home/robothaler/credentials/BeltWinder"
    -Wno-missing-field-initializers
    -std=gnu++2a
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -mtext-section-literals
    -mlongcalls
    -DLOG_LOCAL_LEVEL=ESP_LOG_INFO
    -DCONFIG_HTTPD_WS_SUPPORT=1
    -DARDUHAL_LOG_COLORS
    -DCONFIG_ARDUHAL_ENABLE_HTTPD_WS=1
    -DCHIP_DEVICE_CONFIG_ENABLE_CHIPOBLE=1
    -DCONFIG_USE_BLE_ONLY_FOR_COMMISSIONING=0
    -DCHIP_HAVE_CONFIG_H
    -DESP_TASK_WDT_TIMEOUT_S=30
    -DUSE_GZIP_UI=1

board_build.embed_txtfiles =
    managed_components/espressif__esp_insights/server_certs/https_server.crt

; ============================================================================
; SERIAL UPLOAD - Entwicklung & Initial Flash
; ============================================================================
[env:esp32-serial]
build_type = debug
upload_port = /dev/ttyUSB0
monitor_port = /dev/ttyUSB0
build_flags = 
    ${env.build_flags}
    -DNDEBUG
    -DCORE_DEBUG_LEVEL=3  ; Mehr Debug-Output für Entwicklung

; ============================================================================
; OTA UPLOAD - Production Updates (Hostname)
; ============================================================================
[env:esp32-ota]
build_type = release
upload_protocol = espota
upload_port = beltwinder.local
upload_flags =
    --port=3232
    ; --auth wird automatisch durch extract_ota_password.py gesetzt
extra_scripts = 
    pre:scripts/build_hook.py
    pre:scripts/extract_ota_password.py
build_flags = 
    ${env.build_flags}
    -DNDEBUG
    -DCORE_DEBUG_LEVEL=2  ; Reduzierter Debug-Output für Release

; ============================================================================
; OTA UPLOAD via IP - Fallback für DNS-Probleme
; ============================================================================
[env:esp32-ota-ip]
build_type = release
upload_protocol = espota
upload_port = 192.168.1.123  ; Ersetze mit tatsächlicher IP
upload_flags =
    --port=3232
    ; --auth wird automatisch durch extract_ota_password.py gesetzt
extra_scripts = 
    pre:scripts/build_hook.py
    pre:scripts/extract_ota_password.py
build_flags = 
    ${env.build_flags}
    -DNDEBUG
    -DCORE_DEBUG_LEVEL=2

; ============================================================================
; OTA DEBUG - Für Debugging über OTA
; ============================================================================
[env:esp32-ota-debug]
build_type = debug
upload_protocol = espota
upload_port = beltwinder.local
upload_flags =
    --port=3232
extra_scripts = 
    pre:scripts/build_hook.py
    pre:scripts/extract_ota_password.py
build_flags = 
    ${env.build_flags}
    -DNDEBUG
    -DCORE_DEBUG_LEVEL=4  ; Maximum Debug für Remote-Debugging
